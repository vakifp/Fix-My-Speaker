<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Firebase Blog Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
body{
  background:#f4f6f9;
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
}

/* Navbar */
.navbar{
  border-radius:0 0 12px 12px;
}

/* Cards */
.card{
  border-radius:14px;
  border:none;
}
.card-header{
  font-size:15px;
  padding:10px 14px;
}
.card-body{
  padding:14px;
}

/* Table */
.table th{
  font-size:14px;
}
.table td{
  font-size:13px;
  vertical-align:middle;
}
td.post-cell{
  max-width:220px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Buttons */
.btn-sm{
  padding:4px 8px;
  font-size:12px;
}

/* Pagination */
.pagination{
  justify-content:center;
}

/* Code preview */
pre{
  background:#111;
  color:#0f0;
  padding:14px;
  border-radius:10px;
  font-size:12px;
}

/* Mobile */
@media(max-width:768px){
  .table-responsive{
    font-size:12px;
  }
}
</style>
</head>

<body>

<script>
if(localStorage.getItem("loggedIn") !== "true"){
  window.location.href="login.html";
}
</script>

<!-- NAVBAR -->
<nav class="navbar navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <span class="navbar-brand fw-semibold">Firebase Blog Dashboard</span>
    <button id="logoutBtn" class="btn btn-danger btn-sm">Logout</button>
  </div>
</nav>

<div class="container">

<!-- ALERT -->
<div id="alertBox" class="alert alert-success alert-dismissible fade d-none">
  <span id="alertMsg"></span>
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>

<div class="row g-3">

<!-- ADD POST -->
<div class="col-12 col-md-4">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white fw-semibold">Add Post</div>
    <div class="card-body">
      <form id="addForm">
        <div class="mb-2">
          <label class="form-label small">Title</label>
          <input id="titleInput" class="form-control form-control-sm" required>
        </div>

        <div class="mb-2">
          <label class="form-label small">Post Content</label>
          <textarea id="postInput" rows="4" class="form-control form-control-sm" required></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label small">Image URL</label>
          <input id="imageInput" class="form-control form-control-sm">
        </div>

        <button class="btn btn-primary w-100 btn-sm">Add Post</button>
      </form>
    </div>
  </div>

  <button id="downloadBtn" class="btn btn-success btn-sm w-100 mt-3">
    Download JSON
  </button>
</div>

<!-- TABLE -->
<div class="col-12 col-md-8">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white fw-semibold">
      Saved Posts
    </div>

    <div class="card-body table-responsive">
      <table class="table table-striped align-middle mb-2">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Title</th>
            <th>Post</th>
            <th>Date</th>
            <th width="150">Action</th>
          </tr>
        </thead>
        <tbody id="table"></tbody>
      </table>

      <ul id="pagination" class="pagination mt-2"></ul>
    </div>
  </div>
</div>

</div>

<!-- EDIT MODAL -->
<div class="modal fade" id="editModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editForm">
        <div class="modal-header bg-warning">
          <h6 class="modal-title">Edit Post</h6>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="editId">

          <div class="mb-2">
            <label class="form-label small">Title</label>
            <input id="editTitle" class="form-control form-control-sm" required>
          </div>

          <div class="mb-2">
            <label class="form-label small">Post</label>
            <textarea id="editPost" rows="4" class="form-control form-control-sm" required></textarea>
          </div>

          <div class="mb-2">
            <label class="form-label small">Image URL</label>
            <input id="editImage" class="form-control form-control-sm">
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success btn-sm">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>

</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, push, get, set, remove } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig={
  apiKey:"AIzaSyBZurXYN-O87q4lJPX8ZMpA1AgTemstHyE",
  authDomain:"blogpost-fbe6c.firebaseapp.com",
  databaseURL:"https://blogpost-fbe6c-default-rtdb.firebaseio.com",
  projectId:"blogpost-fbe6c"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);
const postsRef=ref(db,"posts");

const table=document.getElementById("table");
const pagination=document.getElementById("pagination");
const modal=new bootstrap.Modal(document.getElementById("editModal"));

const logoutBtn=document.getElementById("logoutBtn");
const addForm=document.getElementById("addForm");
const editForm=document.getElementById("editForm");

let currentPage=1;
const perPage=10;

/* Alert */
function showAlert(msg){
  alertMsg.textContent=msg;
  alertBox.classList.remove("d-none");
  alertBox.classList.add("show");
  setTimeout(()=>alertBox.classList.add("d-none"),3000);
}

/* Logout */
logoutBtn.onclick=()=>{
  localStorage.removeItem("loggedIn");
  location.href="login.html";
};

/* Load */
async function load(){
  const snap=await get(postsRef);
  if(!snap.exists()) return [];
  return Object.entries(snap.val()).map(([id,d])=>({id,...d}))
}

/* Render */
async function render(){
  const data=(await load()).sort((a,b)=>b.created-a.created);
  const pages=Math.ceil(data.length/perPage);
  const start=(currentPage-1)*perPage;

  table.innerHTML="";
  data.slice(start,start+perPage).forEach((d,i)=>{
    table.innerHTML+=`
    <tr>
      <td>${start+i+1}</td>
      <td>${d.title}</td>
      <td class="post-cell">${d.post}</td>
      <td>${new Date(d.created).toLocaleDateString()}</td>
      <td>
        <button class="btn btn-warning btn-sm" data-id="${d.id}">Edit</button>
        <button class="btn btn-danger btn-sm" data-del="${d.id}">Delete</button>
      </td>
    </tr>`;
  });

  pagination.innerHTML="";
  for(let i=1;i<=pages;i++){
    pagination.innerHTML+=`
    <li class="page-item ${i===currentPage?'active':''}">
      <a class="page-link" href="#">${i}</a>
    </li>`;
  }
}

/* Events */
addForm.onsubmit=async e=>{
  e.preventDefault();
  await push(postsRef,{
    title:titleInput.value,
    post:postInput.value,
    image:imageInput.value,
    created:Date.now()
  });
  addForm.reset();
  showAlert("Post added");
  render();
};

table.onclick=async e=>{
  if(e.target.dataset.id){
    const snap=await get(ref(db,"posts/"+e.target.dataset.id));
    editId.value=e.target.dataset.id;
    editTitle.value=snap.val().title;
    editPost.value=snap.val().post;
    editImage.value=snap.val().image||"";
    modal.show();
  }
  if(e.target.dataset.del){
    if(confirm("Delete post?")){
      await remove(ref(db,"posts/"+e.target.dataset.del));
      showAlert("Post deleted");
      render();
    }
  }
};

editForm.onsubmit=async e=>{
  e.preventDefault();
  await set(ref(db,"posts/"+editId.value),{
    title:editTitle.value,
    post:editPost.value,
    image:editImage.value,
    created:Date.now()
  });
  modal.hide();
  showAlert("Post updated");
  render();
};

render();
</script>

</body>
</html>
